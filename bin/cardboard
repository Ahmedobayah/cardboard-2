#!/usr/bin/env node

var fs = require('fs'),
    Cardboard = require('../'),
    concat = require('concat-stream'),
    queue = require('queue-async'),
    geojsonNormalize = require('geojson-normalize'),
    JSONStream = require('JSONStream'),
    argv = require('minimist')(process.argv.slice(2));

require('dotenv').load();

if (!argv._.length) {
    docs();
    return console.error('database filename required');
}

var tableName = argv._[0];

console.error('endpoint', process.env.Endpoint)

var config = {
    table: tableName,
    endpoint:  process.env.Endpoint,
    region: process.env.Region,
    bucket: process.env.Bucket,
    prefix: tableName
};

var cardboard = new Cardboard(config);

cardboard.createTable(tableName, function(err){
    if (err) {
        console.error(err);
        throw err;
    }

    console.error('your table is ready', tableName);
    ready();
});

function ready() {
    if (!process.stdin.isTTY) {
        process.stdin.pipe(concat(function(buf) {
            var q = queue(10);
            var gj = geojsonNormalize(JSON.parse(buf));
            gj.features.forEach(function(feature) {
                feature.properties.id = feature.id;
                delete feature.id;
                q.defer(cardboard.put, feature, argv.dataset || 'default');
            });
            q.awaitAll(function(err, res) {
                if (err) console.error(err);
                else console.log('inserted');
            });
        }));
        return;
    }
    if (argv.export) {
        cardboard.export()
            .pipe(process.stdout);
    } else if (argv.dump === 'geojson') {
        cardboard.dumpGeoJSON()
            .pipe(process.stdout);
    } else if (argv.dump) {
        cardboard.dump()
            .pipe(JSONStream.stringify())
            .pipe(process.stdout);
    } else if (argv.query) {
        cardboard.bboxQuery(
            argv.query.split(',').map(function(q) { return parseFloat(q); }),
            argv.dataset || 'default',
            function(err, data) {
                if (err) return console.log(err);
                console.log(JSON.stringify(data));
            });
    }
}

function docs() {
    fs.createReadStream(__dirname + '/CLI.md').pipe(process.stdout);
}
